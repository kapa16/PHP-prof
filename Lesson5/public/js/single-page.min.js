class ReviewsControl {
  constructor(source, countReviewOnPage = 5, container = '#reviews-container', form = '#singlePage-form') {
    this.source = source;
    this.container = container;
    this.form = form;
    this.reviews = [];
    this.countReviewOnPage = countReviewOnPage;
    this.pagination = Object;
    this._init();
  }

  _init() {
    this._renderForm();
    fetch(this.source)
      .then(result => result.json())
      .then(data => {
        for (const review of data) {
          this.reviews.push(review);
        }
        if (this.countReviewOnPage) {
          this.pagination = new Pagination(this._getCountReviewParts(), this.container);
          $(this.container)
            .on('click', this.pagination.paginationItemSelector, evt => {
              this.pagination.changePagination(evt);
              this._renderReviews();
            });
        }
        this._renderReviews();
      });
  }

  _getCountReviewParts() {
    return Math.ceil(this.reviews.length / this.countReviewOnPage);
  }

  _renderForm() {
    const $labelUser = $('<label class="form-elements" for="userName">Введите имя</label>');
    const $userId = $('<input class="form-elements" type="text" name="userName" id="userName">');
    $labelUser.append($userId);

    const $text = $('<textarea/>', {
      id: 'reviewText',
      class: "form-elements",
      name: "singlePage",
      cols: "30",
      rows: "10",
      placeholder: "Напишите отзыв"
    });
    const $btn = $('<button class="form-elements" type="submit">Отправить</button>');

    $(this.form)
      .append($labelUser)
      .append($text)
      .append($btn)
      .submit(evt => this._onFormSubmit(evt));
  }

  _renderReviews() {
    $(this.container).text('');
    let reviewsToShow = [];
    if (this.countReviewOnPage) {
      const firstReviewToShow = this.pagination.currentPart * this.countReviewOnPage;
      let lastReviewToShow = firstReviewToShow + this.countReviewOnPage;
      reviewsToShow = this.reviews.slice(firstReviewToShow, lastReviewToShow);
    } else {
      reviewsToShow = this.reviews.slice(0);
    }
    reviewsToShow.forEach(review => this._renderReview(review));

    if (this._getCountReviewParts()) {
      this.pagination.countParts = this._getCountReviewParts();
      this.pagination.render();
    }
  }

  _renderReview(review) {
    const $reviewWrap = $(`<div class="review" data-id="${review.id}"></div>`);
    const $reviewRating = this._getReviewRatingElement();

    const $userName = $(`<p class="review__user  brand-style">${review.author}</p>`);
    const $reviewText = $(`<p class="review__text">${review.text}</p>`);
    const $content = $('<div class="review__content"></div>');
    $content
      .append($userName)
      .append($reviewText);

    const $control = $('<div class="review__control"></div>');

    const $deleteBtn = $(`<div class="fas fa-times-circle delete-product" data-id="${review.id}"></div>`);
    $deleteBtn.click(evt => this._onDeleteClick(evt));
    $control.append($deleteBtn);

    if (review.approved) {
      $reviewWrap.addClass('approved');
    } else {
      const $approveBtn = $(`<div class="button-black review__btn" data-id="${review.id}">Approve</div>`);
      $approveBtn.click(evt => this._onApproveClick(evt));
      $control.append($approveBtn);
    }

    $reviewWrap
      .append($reviewRating)
      .append($content)
      .append($control)
      .prependTo($(this.container));
  }

  _getReviewRatingElement() {
    const $reviewRating = $('<div class="review__rating"></div>');
    for (let i = 0; i < 5; i++) {
      $reviewRating.append('<i class="fas fa-star rating-star"></i>');
    }
    return $reviewRating;
  }

  _getReviewWrap(targetEl) {
    return $(targetEl)
      .closest('.singlePage');
  }

  _findReview(id) {
    for (const review of this.reviews) {
      if (review.id === +id) {
        return review;
      }
    }
  }

  _onApproveClick(evt) {
    this._getReviewWrap(evt.target).addClass('approved')
    const reviewId = evt.target.dataset.id;

    this._findReview(reviewId).approved = true;

    $(evt.target).remove();
  }

  _onDeleteClick(evt) {
    const review = this._findReview(evt.target.dataset.id);
    this.reviews.splice(this.reviews.indexOf(review), 1);
    this._renderReviews();
    // this._getReviewWrap(evt.target).remove();
  }

  _getLastReviewId() {
    const ids = this.reviews.map(obj => obj.id);
    return Math.max(...ids) + 1;
  }

  _addReview() {
    const newReview = {
      id: this._getLastReviewId(),
      author: $('#userName').val(),
      text: $('#reviewText').val()
    };
    this.reviews.push(newReview);
    this._renderReviews();
  }

  _onFormSubmit(evt) {
    evt.preventDefault();
    if (!this.validateForm()) {
      alert('Необходимо заполнить форму');
    }
    this._addReview();
    $('#userName').val('');
    $('#reviewText').val('');
  }

  validateForm() {
    return this._checkField('#userName') && this._checkField('#reviewText');
  }

  _checkField(selector) {
    return $(selector).val().length !== 0;
  }
}
class Carousel {
  /**
   * Конструктор класса карусели
   * @param {String} containerSelector - строка с селектором класса контейнера
   */
  constructor(containerSelector = '.carousel') {
    this.containerSelector = containerSelector;
    this._init();
  }

  /**
   * Инициализация
   * @private
   */
  _init() {
    this._addHandlers();
  }

  /**
   * Добавление слушателя событий нажатия на кнопки смены изображений
   * @private
   */
  _addHandlers() {
    $(this.containerSelector).on('click', '.carousel__control', evt => this._onControlClick(evt))
  }

  /**
   * Обработка нажатий на кнопки смены изображений
   * @param {Event} evt - событие нажатия на кнопку
   * @private
   */
  _onControlClick(evt) {
    let direction = 1;
    if ($(evt.target).closest('.carousel__control').hasClass('carousel__prev')) {
      direction = -1;
    }
    this._changeSlide(direction);
  }

  /**
   * Меняет изображение в переданном направлении
   * @param {Number} direction - направление смены изображения
   * @private
   */
  _changeSlide(direction) {
    const $currentElement = $('.carousel__block:visible');
    const $carouselElements = $('.carousel__block');

    const currentIndex = $currentElement.index();
    const lastElementIndex = $carouselElements.length - 1;
    const nextIndex = this._getNextElementIndex(direction, currentIndex, lastElementIndex);

    $currentElement.hide();
    $carouselElements.eq(nextIndex).show();
  }

  /**
   * Получает индекс следующего элемента карусели, исходя из направления смены элементов
   * @param {Number} direction - направление смены
   * @param {Number} currentIndex - индекс текущего видимого элемента
   * @param {Number} lastElementIndex - индекс последнего элемента в коллекции
   * @returns {Number} - индекс следующего элемента
   * @private
   */
  _getNextElementIndex(direction, currentIndex, lastElementIndex) {
    let nextIndex = currentIndex + direction;
    if (nextIndex < 0) {
      nextIndex = lastElementIndex;
    } else if (nextIndex > lastElementIndex) {
      nextIndex = 0;
    }
    return nextIndex;
  }
}
class SelectColor {
  constructor(colorItems, containerId = '#color') {
    this.colorItems = colorItems;
    this.containerId = containerId;
    this.currenColor = {name: 'no color', color: 'rgba(0,0,0,0)'};
    this.$listWrap = $('<ul/>');
    this._init();
  }

  _init() {
    if (this.colorItems.length) {
      this.currenColor = this.colorItems[0];
      this._createList();
      $(this.containerId).click(() => this.$listWrap.toggle());
      $(this.containerId).on('click', '.select__item', evt => this._onChooseItem(evt))
    }
    this._createMainElement();
    this._setChosenItem();
  }

  _createMainElement() {
    $(this.containerId)
      .append($('<span class="color-example color-select"></span>'))
      .append(`<span class="color-name"></span>`)
      .append('<i class="fas fa-angle-down icon-drop-list"></i>');
  }

  _createList() {
    this.$listWrap = $('<ul class="select__items">');
    this.colorItems.forEach((item) => {
      const $colorExample = $('<span class="color-example"></span>').css('background', item.color);
      this.$listWrap
        .append($(`<li class="select__item">${item.name}</li>`)
          .append($colorExample));
    });
    this.$listWrap
      .hide()
      .appendTo($(this.containerId));
  }

  _setChosenItem() {
    $(this.containerId)
      .find('.color-select')
        .css('background', this.currenColor.color);
    $(this.containerId)
      .find('.color-name')
      .text(this.currenColor.name);
  }

  _onChooseItem(evt){
    const colorName = $(evt.target).text();
    this.currenColor = this.colorItems.find(element => element.name === colorName);
    this._setChosenItem();
  }
}
class Pagination {
  constructor(countParts, container) {
    this.countParts = countParts;
    this.container = container;
    this.currentPart = 0;
    this.paginationItemSelector = '.pagination-link';
  }

  render(){
    const $paginationWrap = $('<div class="pagination-wrap"></div>');
    const $paginationContainer = $('<div class="pagination"></div>');
    $paginationContainer
      .append(`<a href="#" class="pagination-link pagination-link-prev"></a>`);
    for (let i = 0; i < this.countParts; i++) {
      const $paginationPart = $(`<a href="#" class="pagination-link">${i + 1}</a>`);
      if (this.currentPart === i) {
        $paginationPart.addClass('pagination-link-active');
      }
      $paginationContainer.append($paginationPart);
    }
    $paginationContainer
      .append('<a href="#" class="pagination-link pagination-link-next"></a>')
      .appendTo($paginationWrap
        .appendTo($(this.container)));
  }

  changePagination(evt) {
    evt.preventDefault();
    if ($(evt.target).hasClass('pagination-link-prev')) {
      if (--this.currentPart < 0) {
        this.currentPart = 0;
      }
    } else if ($(evt.target).hasClass('pagination-link-next')) {
      if (++this.currentPart > this.countParts - 1) {
        this.currentPart = this.countParts - 1;
      }
    } else {
      this.currentPart = +$(evt.target).text() - 1;
    }
  }
}


$(document).ready(() => {
  const reviews = new ReviewsControl('json/reviews.json');

  const carousel = new Carousel();

  const selectColor = new SelectColor([
    {name: 'red', color: 'red'},
    {name: 'blue', color: 'blue'},
    {name: 'green', color: '#98FB98'}
  ]);

});